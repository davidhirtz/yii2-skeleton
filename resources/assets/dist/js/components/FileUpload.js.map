{
  "version": 3,
  "sources": ["../../../src/js/components/FileUpload.ts"],
  "sourcesContent": ["import htmx from \"htmx.org\"\n\nwindow.customElements.get('file-upload') || window.customElements.define('file-upload', class extends HTMLElement {\n    // noinspection JSUnusedGlobalSymbols\n    connectedCallback() {\n        const $input = this.querySelector('input[type=\"file\"]') as HTMLInputElement | null;\n\n        if (!$input) {\n            return;\n        }\n\n        const $target = (this.dataset.target ? document.querySelector(this.dataset.target) : null) || document.body;\n        const $btn = this.querySelector('button') as HTMLButtonElement;\n        const chunkSize = this.dataset.chunkSize ? parseInt(this.dataset.chunkSize) : 1024 * 1024 * 2;\n        const minProgressSize = chunkSize * 3;\n\n        $input.addEventListener('change', async event => {\n            const files = (event.target as HTMLInputElement).files;\n\n            if (!files) {\n                return;\n            }\n\n            let totalSize = 0;\n\n            for (let fileIndex = 0; fileIndex < files.length; fileIndex++) {\n                totalSize += files[fileIndex].size;\n            }\n\n            const $progress = totalSize > minProgressSize ? document.createElement('progress') : null;\n\n            if ($progress) {\n                $progress.className = 'progress';\n                $progress.max = totalSize;\n                $progress.value = 0;\n                $target.appendChild($progress);\n            }\n\n            $btn.disabled = true;\n\n            for (let fileIndex = 0; fileIndex < files.length; fileIndex++) {\n                const file = files[fileIndex];\n                const totalChunks = Math.ceil(file.size / chunkSize);\n\n                for (let chunkIndex = 0; chunkIndex < totalChunks; chunkIndex++) {\n                    const body = new FormData();\n                    const headers: HeadersInit = new Headers();\n                    const start = chunkIndex * chunkSize;\n                    const end = Math.min(start + chunkSize, file.size);\n\n                    if (start > 0 || end < file.size) {\n                        const blob = file.slice(start, end);\n                        body.append($input.name, new File([blob], file.name, {type: file.type}));\n                        headers.set('Content-Range', `bytes ${start}-${end - 1}/${file.size}`);\n                    } else {\n                        body.append($input.name, file);\n                    }\n\n                    if (fileIndex < files.length - 1) {\n                        headers.set('Prefer', 'status=204');\n                    }\n\n                    headers.set('X-CSRF-Token', Object.values(JSON.parse(document.querySelector('#wrap')!.getAttribute('hx-headers') as string) as Object).pop());\n\n                    await fetch(this.dataset.url as string, {\n                        body: body,\n                        headers: headers,\n                        method: 'POST',\n                    })\n                        .then(response => {\n                            if (response.status === 200) {\n                                response.text().then(html => {\n                                    htmx.swap($target, html, {\n                                        swapStyle: 'outerHTML',\n                                        swapDelay: 0,\n                                        settleDelay: 0,\n                                        show: 'top',\n                                    }, {\n                                        select: this.dataset.target || undefined,\n                                    });\n                                })\n                            } else if (!response.ok) {\n                                alert(response.statusText);\n                                chunkIndex = totalChunks;\n                            }\n\n                            if ($progress) {\n                                $progress.value += (end - start);\n                            }\n                        });\n                }\n            }\n\n            $btn.disabled = false;\n        });\n\n        $btn.onclick = () => $input.click();\n    }\n});"],
  "mappings": "sEAEA,OAAO,eAAe,IAAI,aAAa,GAAK,OAAO,eAAe,OAAO,cAAe,cAAc,WAAY,CAE9G,mBAAoB,CAChB,IAAMA,EAAS,KAAK,cAAc,oBAAoB,EAEtD,GAAI,CAACA,EACD,OAGJ,IAAMC,GAAW,KAAK,QAAQ,OAAS,SAAS,cAAc,KAAK,QAAQ,MAAM,EAAI,OAAS,SAAS,KACjGC,EAAO,KAAK,cAAc,QAAQ,EAClCC,EAAY,KAAK,QAAQ,UAAY,SAAS,KAAK,QAAQ,SAAS,EAAI,KAAO,KAAO,EACtFC,EAAkBD,EAAY,EAEpCH,EAAO,iBAAiB,SAAU,MAAMK,GAAS,CAC7C,IAAMC,EAASD,EAAM,OAA4B,MAEjD,GAAI,CAACC,EACD,OAGJ,IAAIC,EAAY,EAEhB,QAASC,EAAY,EAAGA,EAAYF,EAAM,OAAQE,IAC9CD,GAAaD,EAAME,CAAS,EAAE,KAGlC,IAAMC,EAAYF,EAAYH,EAAkB,SAAS,cAAc,UAAU,EAAI,KAEjFK,IACAA,EAAU,UAAY,WACtBA,EAAU,IAAMF,EAChBE,EAAU,MAAQ,EAClBR,EAAQ,YAAYQ,CAAS,GAGjCP,EAAK,SAAW,GAEhB,QAASM,EAAY,EAAGA,EAAYF,EAAM,OAAQE,IAAa,CAC3D,IAAME,EAAOJ,EAAME,CAAS,EACtBG,EAAc,KAAK,KAAKD,EAAK,KAAOP,CAAS,EAEnD,QAASS,EAAa,EAAGA,EAAaD,EAAaC,IAAc,CAC7D,IAAMC,EAAO,IAAI,SACXC,EAAuB,IAAI,QAC3BC,EAAQH,EAAaT,EACrBa,EAAM,KAAK,IAAID,EAAQZ,EAAWO,EAAK,IAAI,EAEjD,GAAIK,EAAQ,GAAKC,EAAMN,EAAK,KAAM,CAC9B,IAAMO,EAAOP,EAAK,MAAMK,EAAOC,CAAG,EAClCH,EAAK,OAAOb,EAAO,KAAM,IAAI,KAAK,CAACiB,CAAI,EAAGP,EAAK,KAAM,CAAC,KAAMA,EAAK,IAAI,CAAC,CAAC,EACvEI,EAAQ,IAAI,gBAAiB,SAASC,CAAK,IAAIC,EAAM,CAAC,IAAIN,EAAK,IAAI,EAAE,CACzE,MACIG,EAAK,OAAOb,EAAO,KAAMU,CAAI,EAG7BF,EAAYF,EAAM,OAAS,GAC3BQ,EAAQ,IAAI,SAAU,YAAY,EAGtCA,EAAQ,IAAI,eAAgB,OAAO,OAAO,KAAK,MAAM,SAAS,cAAc,OAAO,EAAG,aAAa,YAAY,CAAW,CAAW,EAAE,IAAI,CAAC,EAE5I,MAAM,MAAM,KAAK,QAAQ,IAAe,CACpC,KAAMD,EACN,QAASC,EACT,OAAQ,MACZ,CAAC,EACI,KAAKI,GAAY,CACVA,EAAS,SAAW,IACpBA,EAAS,KAAK,EAAE,KAAKC,GAAQ,CACzBC,EAAK,KAAKnB,EAASkB,EAAM,CACrB,UAAW,YACX,UAAW,EACX,YAAa,EACb,KAAM,KACV,EAAG,CACC,OAAQ,KAAK,QAAQ,QAAU,MACnC,CAAC,CACL,CAAC,EACOD,EAAS,KACjB,MAAMA,EAAS,UAAU,EACzBN,EAAaD,GAGbF,IACAA,EAAU,OAAUO,EAAMD,EAElC,CAAC,CACT,CACJ,CAEAb,EAAK,SAAW,EACpB,CAAC,EAEDA,EAAK,QAAU,IAAMF,EAAO,MAAM,CACtC,CACJ,CAAC",
  "names": ["$input", "$target", "$btn", "chunkSize", "minProgressSize", "event", "files", "totalSize", "fileIndex", "$progress", "file", "totalChunks", "chunkIndex", "body", "headers", "start", "end", "blob", "response", "html", "htmx_esm_default"]
}
